#!/usr/bin/env bash

################################################################################
#
# clbin
# =====
#
# Recursively clean binaries, which have corresponding source files with
# identical names.
#
# For example, there is a file `./foo/bar.c`, and `clbin` will try to find a
# file `bar` in `./` and `rm -f` it.  It's convenient to clean the binaries
# generated by some compilers like `rustc` and `go`, which create executables
# without extensions and hard to *gitignore*.
#
# @author AnqurVanillapy
# @date 29 March 2018
# @version 0.1.1
################################################################################

if [[ "$#" != "0" ]]; then echo "Usage: clbin" && exit 1; fi

function sjoin () {
    local d="$1"
    shift
    echo -n "$1"
    shift
    printf "%s" "${@/#/$d}"
}

read -r -d '' prune_dirs << EOS
.git
EOS

read -r -d '' match_exts << EOS
*.c
*.cc
*.rs
EOS

# set noglob
set -f

exts_args=$(for e in $match_exts; do echo "-name=$e"; done)
dirs_args=$(for d in $prune_dirs; do echo "-not -path ./$d/*"; done)

find . -type f $(sjoin " -o " ${exts_args[@]} | tr '=' ' ') | while read f; do
    binfname="$(basename "$f" .${f##*.})"
    find . $dirs_args -type f -name $binfname | while read binfile; do
        rm -f $binfile
    done
done
